# Getting started with Kubernetes Operator using sample-controller

This repo implements a simple Kubernetes Operator (using sample-controller) that will create a deployment upon creation of custom object 'hello'. The deployment uses 'busybox' docker image and replica sets to create and maintain pods. Each pod echos "Hello World".

Sample-controllers uses k8s.io/code-generator to generate:
* typed clients (clientset)
* informers
* listers
* deep-copy functions (zz_generated.deepcopy.go)

## Steps to follow

Clone the sample-controller repository
```
git clone https://github.com/kubernetes/sample-controller
```

Copy `pkg/apis/samplecontroller` and create a new directory `pkg/apis/helloworld`
```
cp -r pkg/apis/samplecontroller pkg/apis/helloworld
```

Change the following files according to the Operator functionality and remove unwanted code
```
├── register.go
└── v1alpha1
    ├── doc.go
    ├── register.go
    ├── types.go
    └── zz_generated.deepcopy.go (Note that this will is generated by `hack/update-codegen.sh`)
```

Update `hack/update-codegen.sh` if neccessary and execute this script to incorporate the chnages made previously
```
./hack/update-codegen.sh
```

This will generate following files:
```
Generating deepcopy funcs
Generating clientset for helloworld:v1alpha1 at github.com/rutu-k/sample-controller/pkg/generated/clientset
Generating listers for helloworld:v1alpha1 at github.com/rutu-k/sample-controller/pkg/generated/listers
Generating informers for helloworld:v1alpha1 at github.com/rutu-k/sample-controller/pkg/generated/informers
```

Edit or create controller.go and main.go according to the logic the Operator should work

Build the Controller
```
go build -o ctrl .
```

Execute custom resource definition yaml
```
kubectl apply -f artifacts/examples/crd.yaml
```

Verify that crd is generated
```
$ kubectl get crds
NAME                                CREATED AT
hellos.helloworld.kubernetes.info   2019-09-30T10:00:40Z
```

Run the controller binary
```
$ ./ctrl -kubeconfig ~/.kube/config  -logtostderr=true
I0930 19:20:11.633469    4450 controller.go:115] Setting up event handlers
I0930 19:20:11.641432    4450 controller.go:156] Starting helloworld controller
I0930 19:20:11.641567    4450 controller.go:159] Waiting for informer caches to sync
I0930 19:20:12.441950    4450 controller.go:164] Starting workers
I0930 19:20:12.441973    4450 controller.go:170] Started workers
```

Now execute the cr
```
$ kubectl apply -f artifacts/examples/test-helloworld.yaml
hello.helloworld.kubernetes.info/test-hello created
```

Verify that Operator is configured properly
```
$ kubectl get po,rs,deploy,hello
NAME                                    READY   STATUS    RESTARTS   AGE
pod/test-hello-998c78866-rq4v8          1/1     Running   0          58s

NAME                                                DESIRED   CURRENT   READY   AGE
replicaset.extensions/test-hello-998c78866          1         1         1       58s

NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/test-hello         1/1     1            1           58s

NAME                                          AGE
hello.helloworld.kubernetes.info/test-hello   58s
```

```
$ kubectl logs test-hello-998c78866-rq4v8
Every 2.0s: echo Hello World!!!                             2019-09-30 14:08:52

Hello World!!!
```
